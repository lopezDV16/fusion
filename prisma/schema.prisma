generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PrintRequestStatus {
  SUBMITTED
  QUOTED
  APPROVED
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique @db.VarChar(255)
  passwordHash        String               @db.VarChar(255)
  fullName            String               @db.VarChar(120)
  role                UserRole             @default(CUSTOMER)
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  orders              Order[]
  customPrintRequests CustomPrintRequest[]
  addresses           Address[]

  @@index([role, isActive])
}

model Product {
  id                  String               @id @default(cuid())
  slug                String               @unique @db.VarChar(120)
  name                String               @db.VarChar(180)
  description         String?              @db.Text
  basePrice           Decimal              @db.Decimal(10, 2)
  currency            String               @default("SAR") @db.VarChar(3)
  isPublished         Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  variants            ProductVariant[]
  orderItems          OrderItem[]
  customPrintRequests CustomPrintRequest[]

  @@index([isPublished])
  @@index([createdAt])
}

model ProductVariant {
  id               String      @id @default(cuid())
  productId        String
  product          Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku              String      @unique @db.VarChar(80)
  color            String      @db.VarChar(60)
  size             String      @db.VarChar(30)
  stockQuantity    Int         @default(0)
  reservedQuantity Int         @default(0)
  priceAdjustment  Decimal     @default(0) @db.Decimal(10, 2)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  orderItems       OrderItem[]

  @@unique([productId, color, size])
  @@index([productId, stockQuantity])
}

model PrintService {
  id             String               @id @default(cuid())
  slug           String               @unique @db.VarChar(120)
  name           String               @db.VarChar(180)
  description    String?              @db.Text
  basePrice      Decimal?             @db.Decimal(10, 2)
  minQuantity    Int?
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  customRequests CustomPrintRequest[]

  @@index([isActive])
}

model CustomPrintRequest {
  id              String             @id @default(cuid())
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  printServiceId  String
  printService    PrintService       @relation(fields: [printServiceId], references: [id], onDelete: Restrict)
  productId       String?
  product         Product?           @relation(fields: [productId], references: [id], onDelete: SetNull)
  quantity        Int
  selectedSizes   Json?
  designImageUrls String[]           @default([])
  notes           String?            @db.Text
  status          PrintRequestStatus @default(SUBMITTED)
  quotedUnitPrice Decimal?           @db.Decimal(10, 2)
  quotedTotal     Decimal?           @db.Decimal(12, 2)
  currency        String             @default("SAR") @db.VarChar(3)
  orderId         String?            @unique
  order           Order?             @relation(fields: [orderId], references: [id], onDelete: SetNull)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([userId, status])
  @@index([printServiceId])
  @@index([createdAt])
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String?  @db.VarChar(80)
  line1       String   @db.VarChar(180)
  line2       String?  @db.VarChar(180)
  city        String   @db.VarChar(80)
  state       String?  @db.VarChar(80)
  postalCode  String?  @db.VarChar(24)
  countryCode String   @default("SA") @db.VarChar(2)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([userId, isDefault])
}

model Order {
  id                String              @id @default(cuid())
  orderNumber       String              @unique @db.VarChar(40)
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Restrict)
  status            OrderStatus         @default(PENDING)
  paymentStatus     PaymentStatus       @default(UNPAID)
  subtotal          Decimal             @db.Decimal(12, 2)
  shippingFee       Decimal             @default(0) @db.Decimal(12, 2)
  taxAmount         Decimal             @default(0) @db.Decimal(12, 2)
  total             Decimal             @db.Decimal(12, 2)
  currency          String              @default("SAR") @db.VarChar(3)
  shippingAddressId String?
  shippingAddress   Address?            @relation(fields: [shippingAddressId], references: [id], onDelete: SetNull)
  notes             String?             @db.Text
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  items             OrderItem[]
  printRequest      CustomPrintRequest?

  @@index([userId, status])
  @@index([createdAt])
}

model OrderItem {
  id           String          @id @default(cuid())
  orderId      String
  order        Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId    String
  product      Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variantId    String?
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  productName  String          @db.VarChar(180)
  variantLabel String?         @db.VarChar(120)
  unitPrice    Decimal         @db.Decimal(12, 2)
  quantity     Int
  lineTotal    Decimal         @db.Decimal(12, 2)
  createdAt    DateTime        @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}
